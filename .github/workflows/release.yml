name: WolfLoom Build & Release

# Trigger on pushes to /server or manual trigger
on:
  push:
    paths:
      - 'server/**'
  workflow_dispatch:  # allows manual trigger

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        python-version: [3.13]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller flask psutil

      - name: Build WolfLoom
        working-directory: ./server
        run: |
          mkdir -p dist
          pyinstaller --onefile --windowed control.py

      - name: Zip build
        working-directory: ./server
        run: |
          BUILD_OS="${{ matrix.os }}"
          ZIP_NAME="WolfLoom-${BUILD_OS}.zip"
          mkdir -p release
          if [[ "$BUILD_OS" == "windows-latest" ]]; then
              7z a release/$ZIP_NAME dist/control.exe
          else
              zip -j release/$ZIP_NAME dist/control
          fi

      - name: Create GitHub Release
        id: create_release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ github.run_number }}
          name: WolfLoom v${{ github.run_number }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload build to release
        uses: softprops/action-gh-release@v1
        with:
          files: ./server/release/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
